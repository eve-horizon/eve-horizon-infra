# =============================================================================
# Version Upgrade Detection
# =============================================================================
#
# Runs daily to check whether a newer Eve Horizon version is available in the
# container registry. If a newer tag is found, opens a PR that bumps the
# version in config/platform.yaml.
#
# Secrets required:
#   REGISTRY_TOKEN - GitHub token with packages:read (required only for GHCR registries)
#   AWS_ACCESS_KEY_ID / AWS_SECRET_ACCESS_KEY - required when platform.registry points to private ECR
# =============================================================================

name: Upgrade Check

on:
  schedule:
    - cron: '0 8 * * *'       # Daily at 08:00 UTC

  workflow_dispatch: {}        # Allow manual trigger

permissions:
  contents: write
  pull-requests: write
  packages: read

jobs:
  check-upgrade:
    name: Check for Platform Upgrade
    runs-on: ubuntu-latest

    steps:
      # -----------------------------------------------------------------------
      # Checkout
      # -----------------------------------------------------------------------
      - name: Checkout
        uses: actions/checkout@v4

      # -----------------------------------------------------------------------
      # Read current version from config
      # -----------------------------------------------------------------------
      - name: Read platform config
        id: config
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/download/v4.40.5/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

          CONFIG=config/platform.yaml
          echo "current_version=$(yq '.platform.version' $CONFIG)" >> $GITHUB_OUTPUT
          echo "registry=$(yq '.platform.registry' $CONFIG)"       >> $GITHUB_OUTPUT
          echo "region=$(yq '.region' $CONFIG)"                    >> $GITHUB_OUTPUT

      - name: Configure AWS credentials for ECR registry queries
        if: contains(steps.config.outputs.registry, '.dkr.ecr.')
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ steps.config.outputs.region }}

      # -----------------------------------------------------------------------
      # Query registry for latest version tag
      # -----------------------------------------------------------------------
      - name: Check latest available version
        id: latest
        env:
          REGISTRY_TOKEN: ${{ secrets.REGISTRY_TOKEN }}
          REGISTRY: ${{ steps.config.outputs.registry }}
          CURRENT: ${{ steps.config.outputs.current_version }}
          REGION: ${{ steps.config.outputs.region }}
        run: |
          echo "Current version: ${CURRENT}"
          echo "Registry: ${REGISTRY}"

          REGISTRY_HOST="${REGISTRY%%/*}"
          REGISTRY_PATH="${REGISTRY#*/}"
          TAGS=""

          if [[ "$REGISTRY_HOST" == "ghcr.io" ]]; then
            ORG_IMAGE="${REGISTRY_PATH}"
            TAGS=$(curl -sL \
              -H "Authorization: Bearer $(echo -n "$REGISTRY_TOKEN" | base64 -w0 2>/dev/null || echo -n "$REGISTRY_TOKEN" | base64)" \
              "https://ghcr.io/v2/${ORG_IMAGE}/api/tags/list" 2>/dev/null \
              | jq -r '.tags[]? // empty' 2>/dev/null || echo "")

            if [[ -z "$TAGS" ]]; then
              ORG="${ORG_IMAGE%%/*}"
              TAGS=$(gh api \
                -H "Accept: application/vnd.github+json" \
                "/orgs/${ORG}/packages/container/api/versions" \
                --jq '.[].metadata.container.tags[]' 2>/dev/null || echo "")
            fi
          elif [[ "$REGISTRY_HOST" == *.dkr.ecr.*.amazonaws.com ]]; then
            API_REPOSITORY="${REGISTRY_PATH}/api"
            TAGS=$(aws ecr describe-images \
              --repository-name "$API_REPOSITORY" \
              --query 'imageDetails[].imageTags[]' \
              --output text 2>/dev/null \
              | tr '\t' '\n' \
              | tr ' ' '\n' \
              | sed '/^None$/d' \
              || echo "")
          elif [[ "$REGISTRY_HOST" == "public.ecr.aws" ]]; then
            REGISTRY_ALIAS="${REGISTRY_PATH%%/*}"
            REGISTRY_NAMESPACE="${REGISTRY_PATH#*/}"
            if [[ -z "$REGISTRY_ALIAS" || -z "$REGISTRY_NAMESPACE" || "$REGISTRY_NAMESPACE" == "$REGISTRY_PATH" ]]; then
              echo "Invalid ECR Public registry path: ${REGISTRY_PATH}"
              echo "expected: public.ecr.aws/<alias>/<namespace>"
              echo "available=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            API_REPOSITORY="${REGISTRY_NAMESPACE}/api"
            TOKEN=$(curl -sL \
              "https://public.ecr.aws/token/?service=public.ecr.aws&scope=repository:${API_REPOSITORY}:pull" 2>/dev/null \
              | jq -r '.token // empty' 2>/dev/null || echo "")
            if [[ -z "$TOKEN" ]]; then
              echo "Could not retrieve anonymous token for public ECR"
              echo "available=false" >> $GITHUB_OUTPUT
              exit 0
            fi
            TAGS=$(curl -sL \
              -H "Authorization: Bearer ${TOKEN}" \
              "https://public.ecr.aws/v2/${REGISTRY_ALIAS}/${API_REPOSITORY}/tags/list" 2>/dev/null \
              | jq -r '.tags[]? // empty' 2>/dev/null || echo "")
          else
            echo "Unsupported registry host: ${REGISTRY_HOST}"
            echo "available=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          if [[ -z "$TAGS" ]]; then
            echo "Could not retrieve tags from registry"
            echo "available=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Filter to semver-like tags (e.g. 0.1.28, 1.0.0) and sort
          LATEST=$(echo "$TAGS" \
            | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' \
            | sort -t. -k1,1n -k2,2n -k3,3n \
            | tail -n1 || true)

          if [[ -z "$LATEST" ]]; then
            echo "No semver tags found in registry"
            echo "available=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Latest available version: ${LATEST}"
          echo "latest=$LATEST" >> $GITHUB_OUTPUT

          # Compare versions using sort -V
          if [[ "$LATEST" == "$CURRENT" ]]; then
            echo "Already on latest version"
            echo "available=false" >> $GITHUB_OUTPUT
          elif [[ "$(printf '%s\n%s' "$CURRENT" "$LATEST" | sort -V | tail -n1)" == "$LATEST" ]]; then
            echo "Upgrade available: ${CURRENT} → ${LATEST}"
            echo "available=true" >> $GITHUB_OUTPUT
          else
            echo "Current version is ahead of registry (${CURRENT} > ${LATEST})"
            echo "available=false" >> $GITHUB_OUTPUT
          fi

      # -----------------------------------------------------------------------
      # Check for existing PR (avoid duplicates)
      # -----------------------------------------------------------------------
      - name: Check for existing upgrade PR
        if: steps.latest.outputs.available == 'true'
        id: existing
        env:
          GH_TOKEN: ${{ github.token }}
          LATEST: ${{ steps.latest.outputs.latest }}
        run: |
          BRANCH="chore/upgrade-eve-${LATEST}"
          EXISTING=$(gh pr list --state open --head "$BRANCH" --json number --jq '.[0].number' 2>/dev/null || echo "")

          if [[ -n "$EXISTING" ]]; then
            echo "PR #${EXISTING} already open for version ${LATEST}"
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      # -----------------------------------------------------------------------
      # Create upgrade PR
      # -----------------------------------------------------------------------
      - name: Create upgrade branch and PR
        if: steps.latest.outputs.available == 'true' && steps.existing.outputs.exists != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
          CURRENT: ${{ steps.config.outputs.current_version }}
          LATEST: ${{ steps.latest.outputs.latest }}
          REGISTRY: ${{ steps.config.outputs.registry }}
        run: |
          BRANCH="chore/upgrade-eve-${LATEST}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch
          git checkout -b "$BRANCH"

          # Update version in platform.yaml
          yq -i ".platform.version = \"${LATEST}\"" config/platform.yaml

          # Commit and push
          git add config/platform.yaml
          git commit -m "chore: upgrade Eve Horizon to ${LATEST}"
          git push origin "$BRANCH"

          # Build PR body
          PR_BODY="$(cat <<EOF
          ## Upgrade Eve Horizon

          | | Version |
          |---|---|
          | **Current** | \`${CURRENT}\` |
          | **Available** | \`${LATEST}\` |
          | **Registry** | \`${REGISTRY}\` |

          ### What this PR does

          Updates \`config/platform.yaml\` to pin platform version to **${LATEST}**.

          After merging, trigger a deploy by either:
          - Pushing a \`deploy-v${LATEST}\` tag
          - Running the Deploy workflow manually

          ### Release notes

          Check the source repository for changes between versions:
          \`\`\`
          ${CURRENT} → ${LATEST}
          \`\`\`

          ---
          *This PR was created automatically by the [Upgrade Check](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) workflow.*
          EOF
          )"

          # Create PR
          gh pr create \
            --title "chore: upgrade Eve Horizon to ${LATEST}" \
            --body "$PR_BODY" \
            --label "upgrade,automated"
